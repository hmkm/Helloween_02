<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>browserCamamera sample01</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <style>
        /*html {
            height: 100%;
        }*/

        /*body {
            margin: 0 auto;
            height: 100%;
        }*/
        html,
        body {
            height: 100%;
            margin: 0;
            overflow: hidden;
            width: 100%;
        }

        video {
            width: 0.1%;
            height: 0.1%;
            object-fit: fill;
        }

        #wrap {
            height: 100%;
            width: 100%;
        }

        #canvas {
            /*background: #2FCDB4;*/
            display: block;
        }

        #button {
            display: block;
            cursor: pointer;
        }

        img.button:active {
            position: relative;
            top: 3px;
        }
    </style>
</head>
<body>
    <img id="button" class="button" src="button.png" width="0" height="0" ontouchstart="" data-html2canvas-ignore="true" />

    <video id="video" autoplay playsinline="true"></video>
    <script>
        var video = document.getElementById('video');
        var constraints = {
            audio: false,
            video: {
                // スマホのバックカメラを使用
                facingMode: 'environment'
            }
        };
        //  カメラの映像を取得
        navigator.mediaDevices.getUserMedia(constraints)
            .then((stream) => {
                video.srcObject = stream;
            })
            .catch((err) => {
                window.alert(err.name + ': ' + err.message);
            });

        function revCamera() {
            if (num % 2 == 0) {
                constraints = { video: { facingMode: 'environment' } };
                //  カメラの映像をあっち向きに
                navigator.mediaDevices.getUserMedia(constraints)
                    .then((stream) => {
                        video.srcObject = stream;
                    })
                    .catch((err) => {
                        window.alert(err.name + ': ' + err.message);
                    });
            } else {
                constraints = { video: { facingMode: 'user' } };
                //  カメラの映像をこっち向きに
                navigator.mediaDevices.getUserMedia(constraints)
                    .then((stream) => {
                        video.srcObject = stream;
                    })
                    .catch((err) => {
                        window.alert(err.name + ': ' + err.message);
                    });

            }
        }
    </script>

    <div id="wrap">
        <canvas id="canvas"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.js"></script>

    <script>
        (function () {
            var canvas = document.getElementById('canvas');
            var container = document.getElementById('wrap');
            sizing();

            function sizing() {
                canvas.height = container.offsetHeight;
                canvas.width = container.offsetWidth;
            }

            window.addEventListener('resize', function () {
                (!window.requestAnimationFrame) ? setTimeout(sizing, 300) : window.requestAnimationFrame(sizing);
            });
        })();



        //var canvasData = null;

        // html2canvas実行
        function screenshotHtml() {
            html2canvas(document.body, {
                onrendered: function (canvas) {
                    document.body.appendChild(canvas);
                    canvasData = canvas;
                }
            });
        }

        // 画像のダウンロード
        function downloadImage() {
            //var dataUrl = canvasData.toDataURL("image/png");   // canvasをPNG形式に変換
            ////イベント作成
            //var event = document.createEvent("MouseEvents");
            //event.initMouseEvent("click", true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            //var a = document.createElementNS("http://www.w3.org/1999/xhtml", "a"); //a要素を作成
            //a.href = dataUrl; //href -- 指定したURLへ移動　ダウンロード用URLセット
            //a.download = 'helloween_A.png'; //ファイル名セット
            //a.dispatchEvent(event); //イベント発火
            ////alert("-----------------ば!!");
        }
    </script>

    <img id="img" onclick="chgImg()" src="happy.png" width="0" height="0" />
    <script>
        var num = 2;

        if (num >= 100) {
            num = 0;
        }

        function chgImg() {

            if (num % 2 == 0) {
                document.getElementById("img").src = "scared.png";
                num++;
            } else {
                document.getElementById("img").src = "happy.png";
                num++;
            }
        }

        //クリックで画面キャプチャ
        document.getElementById("button").onclick = (event) => {
            let canvas = document.getElementById("canvas");

            let link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = "helloween_A.png";
            link.click();
        }

        //document.getElementById("button").onclick = function () {
        //    screenshotHtml();
        //    downloadImage();

        //    //let promise = new Promise(() => {
        //    //    screenshotHtml();
        //    //})

        //    //promise.then(() => {
        //    //    downloadImage();
        //    //})
        //    //console.log("ばははははｈばばば");
        //    //chgImg();
        //    //revCamera();
        //    //document.getElementById("img").src = "scared.png";
        //    //video: { facingMode: 'user' };
        //};
    </script>

    <script type="text/javascript" src="processor.js"></script>

    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="//code.createjs.com/easeljs-0.8.1.min.js"></script>
    <script type="text/javascript" src="//code.createjs.com/preloadjs-0.6.1.min.js"></script>
    <script>

        $(document).ready(function () {
            // 画像を読み込み
            var loader = new createjs.LoadQueue();
            loader.on("complete", completePreload, this);
            loader.loadManifest([{ id: "button", src: "button.png" }]);
        });

            // 画像読み込み完了
        var completePreload = function (event)
        {
            // 画像インスタンス
            var image = event.target.getResult("button");

            // canvasを取得
            var stage = new createjs.Stage("canvas");

            // 画像をセット
            var bitmap = new createjs.Bitmap(image);
            bitmap.foo = 'bar';
            //bitmap.addEventListener("click", function (event) { alert(event.target.foo); });
            bitmap.addEventListener("click", function (event) {
                //let canvas = document.getElementById("canvas");

                let link = document.createElement("a");
                link.href = canvas.toDataURL("image/png");
                link.download = "helloween_A.png";
                link.click(); });
            stage.addChild(bitmap);

            // canvas更新
            stage.update();
        }
    </script>
    <!--<button id="download">download</button>-->
    <!--<script>
        document.getElementById("download").onclick = (event) => {
            let canvas = document.getElementById("canvas");

            let link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = "test.png";
            link.click();
        }
    </script>-->
    <!--<script>
        var p = document.getElementById('button');
        function hogehoge() {
            var camm = document.getElementById('video');
            camm.facingMode = 'user';
        }

        p.attachEvent('onclick', hogehoge);

        //function chgImg() {
        //    var png = this.canvas.toDataURL();
        //    document.getElementById("newImg").src = png;
        //}
    </script>-->


</body>
</html>